{% extends "base.html" %}

{% block title %}Salon {{ code }} - chess.io{% endblock %}

{% block extra_css %}
<style>
    .room-container {
        max-width: 1000px;
        margin: 2rem auto;
    }

    .room-header {
        background: #262421;
        border: 2px solid #3d3b38;
        border-radius: 16px;
        padding: 2rem;
        margin-bottom: 2rem;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        text-align: center;
    }

    .room-header h2 {
        color: #b8b6b3;
        margin-bottom: 1rem;
    }

    .room-code {
        font-size: 3rem;
        font-weight: bold;
        color: #81b64c;
        letter-spacing: 0.5rem;
        margin: 1rem 0;
        font-family: monospace;
    }

    .share-info {
        background: rgba(129, 182, 76, 0.1);
        padding: 1rem;
        border-radius: 8px;
        margin-top: 1rem;
        color: #81b64c;
        border: 1px solid #81b64c;
    }

    .copy-btn {
        background: #81b64c;
        color: white;
        border: none;
        padding: 0.6rem 1.5rem;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        margin-top: 0.5rem;
        transition: all 0.3s;
    }

    .copy-btn:hover {
        background: #9ac95a;
        transform: translateY(-2px);
    }

    .ready-section {
        background: #1a1917;
        padding: 1.5rem;
        border-radius: 8px;
        margin-top: 1rem;
        border: 2px solid #3d3b38;
    }

    .ready-status {
        display: flex;
        justify-content: space-around;
        margin-bottom: 1rem;
        gap: 1rem;
    }

    .ready-indicator {
        flex: 1;
        background: #262421;
        padding: 1rem;
        border-radius: 8px;
        border: 2px solid #3d3b38;
        text-align: center;
        transition: all 0.3s;
    }

    .ready-indicator.ready {
        border-color: #f6c244;
        background: rgba(246, 194, 68, 0.1);
    }

    .ready-indicator .player-icon {
        font-size: 2rem;
        margin-bottom: 0.5rem;
    }

    .ready-indicator .player-label {
        color: #7c7a77;
        font-size: 0.9rem;
        margin-bottom: 0.5rem;
    }

    .ready-indicator .ready-badge {
        display: inline-block;
        background: #f6c244;
        color: #1a1917;
        padding: 0.3rem 0.8rem;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: bold;
        margin-top: 0.5rem;
        opacity: 0;
        transition: opacity 0.3s;
    }

    .ready-indicator.ready .ready-badge {
        opacity: 1;
    }

    .ready-btn {
        width: 100%;
        background: #81b64c;
        color: white;
        border: none;
        padding: 1rem 2rem;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 700;
        font-size: 1.1rem;
        transition: all 0.3s;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .ready-btn:hover:not(:disabled) {
        background: #9ac95a;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(129, 182, 76, 0.4);
    }

    .ready-btn.ready {
        background: #f6c244;
        color: #1a1917;
    }

    .ready-btn.ready:hover {
        background: #ffd666;
    }

    .ready-btn:disabled {
        background: #4a4845;
        cursor: not-allowed;
        transform: none;
        color: #7c7a77;
    }

    .game-layout {
        display: grid;
        grid-template-columns: 1fr 500px 1fr;
        gap: 2rem;
        align-items: start;
    }

    .player-info {
        background: #262421;
        border: 2px solid #3d3b38;
        border-radius: 16px;
        padding: 1.5rem;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        text-align: center;
    }

    .player-name {
        font-size: 1.5rem;
        font-weight: bold;
        margin-bottom: 0.5rem;
        color: #b8b6b3;
    }

    .player-color {
        display: inline-block;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-weight: 600;
        margin-top: 0.5rem;
    }

    .player-white {
        background: #3d3b38;
        color: #eeeed2;
    }

    .player-black {
        background: #1a1917;
        color: #b8b6b3;
        border: 2px solid #3d3b38;
    }

    .chess-board-wrapper {
        background: #262421;
        border: 2px solid #3d3b38;
        border-radius: 16px;
        padding: 2rem;
        box-shadow: 0 8px 24px rgba(0,0,0,0.4);
        opacity: 0.5;
        pointer-events: none;
        transition: opacity 0.3s;
    }

    .chess-board-wrapper.active {
        opacity: 1;
        pointer-events: all;
    }

    .chess-board {
        display: grid;
        grid-template-columns: repeat(8, 60px);
        grid-template-rows: repeat(8, 60px);
        border: 4px solid #3d3b38;
        margin: 0 auto;
        width: fit-content;
        box-shadow: 0 4px 16px rgba(0,0,0,0.4);
    }

    .square {
        width: 60px;
        height: 60px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s;
        user-select: none;
        position: relative;
    }

    .piece-img {
        width: 52px;
        height: 52px;
        filter: drop-shadow(0 1px 2px rgba(0,0,0,0.3));
        position: absolute;
        pointer-events: none !important;
        -webkit-user-drag: none;
    }

    .square.light { background-color: #eeeed2; }
    .square.dark { background-color: #769656; }

    .square.selected {
        background-color: #baca44 !important;
        box-shadow: inset 0 0 10px rgba(0,0,0,0.3);
    }

    .square.legal-move::after {
        content: '';
        position: absolute;
        width: 20px;
        height: 20px;
        background: rgba(0, 0, 0, 0.15);
        border-radius: 50%;
    }

    .square:hover {
        opacity: 0.9;
    }

    .game-status {
        background: #1a1917;
        padding: 1rem;
        border-radius: 10px;
        text-align: center;
        margin-bottom: 1rem;
        font-weight: 600;
        border: 2px solid #3d3b38;
        color: #b8b6b3;
    }

    .control-btn {
        padding: 0.8rem;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        width: 100%;
        margin-top: 1rem;
        background: #cc3f3f;
        color: white;
        font-family: 'Inter', sans-serif;
    }

    .control-btn:hover {
        background: #b33636;
    }

    @media (max-width: 1200px) {
        .game-layout {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="room-container">
    <div class="room-header">
        <h2>üîí Salon Priv√©</h2>
        <div class="room-code">{{ code }}</div>
        
        <div class="share-info" id="roomStatus">
            üì§ Partagez ce lien avec votre ami
        </div>
        
        <div class="ready-section" id="readySection">
            <div class="ready-status">
                <div class="ready-indicator" id="whiteReady">
                    <div class="player-icon">‚ôî</div>
                    <div class="player-label">Blancs</div>
                    <div style="color: #7c7a77; font-size: 0.85rem;">En attente...</div>
                    <div class="ready-badge">‚úì PR√äT</div>
                </div>
                
                <div class="ready-indicator" id="blackReady">
                    <div class="player-icon">‚ôö</div>
                    <div class="player-label">Noirs</div>
                    <div style="color: #7c7a77; font-size: 0.85rem;">En attente...</div>
                    <div class="ready-badge">‚úì PR√äT</div>
                </div>
            </div>
            
            <button class="ready-btn" id="readyBtn" onclick="toggleReady()">
                ‚úì Je suis pr√™t
            </button>
        </div>
        
        <button class="copy-btn" onclick="copyCode()">
            üìã Copier le lien complet
        </button>
    </div>

    <div class="game-layout">
        <div class="player-info">
            <div class="player-name" id="whitePlayer">Joueur 1</div>
            <div class="player-color player-white">‚ôî Blancs</div>
        </div>

        <div class="chess-board-wrapper" id="boardWrapper">
            <div class="game-status" id="gameStatus">
                ‚è≥ En attente des joueurs...
            </div>

            <div class="chess-board" id="chessBoard"></div>

            <button class="control-btn" onclick="leaveRoom()">
                üö™ Quitter le salon
            </button>
        </div>

        <div class="player-info">
            <div class="player-name" id="blackPlayer">En attente...</div>
            <div class="player-color player-black">‚ôö Noirs</div>
        </div>
    </div>
</div>

<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.12.1/chess.min.js"></script>
<script>
const PIECE_IMAGES = {
    'P': 'https://images.chesscomfiles.com/chess-themes/pieces/neo/150/wp.png',
    'N': 'https://images.chesscomfiles.com/chess-themes/pieces/neo/150/wn.png',
    'B': 'https://images.chesscomfiles.com/chess-themes/pieces/neo/150/wb.png',
    'R': 'https://images.chesscomfiles.com/chess-themes/pieces/neo/150/wr.png',
    'Q': 'https://images.chesscomfiles.com/chess-themes/pieces/neo/150/wq.png',
    'K': 'https://images.chesscomfiles.com/chess-themes/pieces/neo/150/wk.png',
    'p': 'https://images.chesscomfiles.com/chess-themes/pieces/neo/150/bp.png',
    'n': 'https://images.chesscomfiles.com/chess-themes/pieces/neo/150/bn.png',
    'b': 'https://images.chesscomfiles.com/chess-themes/pieces/neo/150/bb.png',
    'r': 'https://images.chesscomfiles.com/chess-themes/pieces/neo/150/br.png',
    'q': 'https://images.chesscomfiles.com/chess-themes/pieces/neo/150/bq.png',
    'k': 'https://images.chesscomfiles.com/chess-themes/pieces/neo/150/bk.png'
};

const socket = io();
const roomCode = '{{ code }}';

let board = '{{ room.board_state }}';
let selectedSquare = null;
let legalMoves = [];
let myColor = null;
let currentTurn = 'white';
let gameStarted = false;
let isReady = false;

window.onload = function() {
    socket.emit('join', { room: roomCode });
    renderBoard();
};

// √âv√©nement : couleur assign√©e
socket.on('assign_color', function(data) {
    myColor = data.color;
    console.log('üé® Couleur assign√©e:', myColor);
    
    if (myColor === 'white') {
        document.getElementById('whitePlayer').innerHTML = 'Vous ‚ôî';
        document.querySelector('#whiteReady .player-label').innerHTML = '<strong>Vous</strong>';
    } else if (myColor === 'black') {
        document.getElementById('blackPlayer').innerHTML = 'Vous ‚ôö';
        document.querySelector('#blackReady .player-label').innerHTML = '<strong>Vous</strong>';
    } else {
        document.getElementById('gameStatus').innerHTML = 'üëÅÔ∏è Mode spectateur';
        document.getElementById('readyBtn').style.display = 'none';
    }
});

// Mise √† jour du statut des joueurs
socket.on('player_status', function(data) {
    console.log('üìä Status:', data);
    
    const readyBtn = document.getElementById('readyBtn');
    const gameStatus = document.getElementById('gameStatus');
    
    if (data.player_count < 2) {
        readyBtn.disabled = true;
        readyBtn.textContent = '‚è≥ En attente du joueur 2...';
        gameStatus.innerHTML = '‚è≥ En attente d\'un adversaire...';
    } else {
        readyBtn.disabled = false;
        if (isReady) {
            readyBtn.textContent = '‚úì Pr√™t (Cliquer pour annuler)';
            readyBtn.classList.add('ready');
        } else {
            readyBtn.textContent = '‚úì Je suis pr√™t';
            readyBtn.classList.remove('ready');
        }
        
        if (data.ready_count === 0) {
            gameStatus.innerHTML = 'üéØ Cliquez sur "Je suis pr√™t" pour commencer';
        } else if (data.ready_count === 1) {
            gameStatus.innerHTML = '‚è≥ En attente de l\'autre joueur...';
        }
    }
});

// Fonction toggle ready
function toggleReady() {
    isReady = !isReady;
    socket.emit('toggle_ready', { room: roomCode });
    
    // Mise √† jour visuelle locale
    if (myColor === 'white') {
        if (isReady) {
            document.getElementById('whiteReady').classList.add('ready');
        } else {
            document.getElementById('whiteReady').classList.remove('ready');
        }
    } else if (myColor === 'black') {
        if (isReady) {
            document.getElementById('blackReady').classList.add('ready');
        } else {
            document.getElementById('blackReady').classList.remove('ready');
        }
    }
}

// √âv√©nement : partie commence
socket.on('game_start', function(data) {
    console.log('üéÆ Partie commence !');
    gameStarted = true;
    
    document.getElementById('readySection').style.display = 'none';
    document.getElementById('boardWrapper').classList.add('active');
    
    document.getElementById('roomStatus').innerHTML = '‚úÖ Partie en cours !';
    document.getElementById('roomStatus').style.background = 'rgba(129, 182, 76, 0.2)';
    document.getElementById('roomStatus').style.color = '#9ac95a';
    document.getElementById('roomStatus').style.borderColor = '#9ac95a';
    
    document.getElementById('whitePlayer').innerHTML = myColor === 'white' ? 'Vous ‚ôî' : 'Adversaire';
    document.getElementById('blackPlayer').innerHTML = myColor === 'black' ? 'Vous ‚ôö' : 'Adversaire';
    document.getElementById('gameStatus').innerHTML = '‚ñ∂Ô∏è Au tour des Blancs';
});

socket.on('move_made', function(data) {
    board = data.board;
    currentTurn = board.split(' ')[1] === 'w' ? 'white' : 'black';
    selectedSquare = null;
    legalMoves = [];
    renderBoard();
    
    const turn = currentTurn === 'white' ? 'Blancs' : 'Noirs';
    document.getElementById('gameStatus').innerHTML = `‚ñ∂Ô∏è Au tour des ${turn}`;
    
    if (data.game_over) {
        handleGameOver(data.result);
    }
});

socket.on('player_left', function(data) {
    console.log('‚ùå Joueur parti, restants:', data.count);
    gameStarted = false;
    isReady = false;
    
    document.getElementById('boardWrapper').classList.remove('active');
    document.getElementById('readySection').style.display = 'block';
    document.getElementById('whiteReady').classList.remove('ready');
    document.getElementById('blackReady').classList.remove('ready');
    
    if (data.count === 1) {
        document.getElementById('gameStatus').innerHTML = '‚ö†Ô∏è Adversaire d√©connect√©';
        document.getElementById('roomStatus').innerHTML = 'üì§ En attente d\'un nouveau joueur...';
        document.getElementById('roomStatus').style.background = 'rgba(204, 63, 63, 0.1)';
        document.getElementById('roomStatus').style.color = '#ff6b6b';
    }
});

socket.on('error', function(data) {
    alert('‚ùå ' + data.message);
});

function parseFEN(fen) {
    const ranks = fen.split(' ')[0].split('/');
    const pieces = [];
    
    for (let rank = 0; rank < 8; rank++) {
        let file = 0;
        for (let char of ranks[rank]) {
            if (char >= '1' && char <= '8') {
                for (let i = 0; i < parseInt(char); i++) {
                    pieces.push(null);
                    file++;
                }
            } else {
                pieces.push(char);
                file++;
            }
        }
    }
    return pieces;
}

function indexToSquare(index) {
    const file = index % 8;
    const rank = 7 - Math.floor(index / 8);
    return String.fromCharCode(97 + file) + (rank + 1);
}

function renderBoard() {
    const boardEl = document.getElementById('chessBoard');
    boardEl.innerHTML = '';
    
    const pieces = parseFEN(board);
    
    for (let i = 0; i < 64; i++) {
        const square = document.createElement('div');
        const rank = Math.floor(i / 8);
        const file = i % 8;
        
        square.className = 'square ' + ((rank + file) % 2 === 0 ? 'light' : 'dark');
        const squareName = indexToSquare(i);
        square.dataset.square = squareName;
        square.dataset.piece = pieces[i] || '';
        
        if (pieces[i]) {
            const img = document.createElement('img');
            img.src = PIECE_IMAGES[pieces[i]];
            img.className = 'piece-img';
            img.draggable = false;
            square.appendChild(img);
        }
        
        if (gameStarted && isMyTurn()) {
            square.onclick = function() {
                handleSquareClick(squareName, pieces[i] || '');
            };
        }
        
        boardEl.appendChild(square);
    }
    
    updateVisualState();
}

function isMyTurn() {
    if (!myColor || !gameStarted) return false;
    return currentTurn === myColor;
}

function updateVisualState() {
    document.querySelectorAll('.square').forEach(sq => {
        sq.classList.remove('selected', 'legal-move');
    });
    
    if (selectedSquare !== null) {
        const selectedEl = document.querySelector(`[data-square="${selectedSquare}"]`);
        if (selectedEl) selectedEl.classList.add('selected');
        
        legalMoves.forEach(move => {
            const moveEl = document.querySelector(`[data-square="${move}"]`);
            if (moveEl) moveEl.classList.add('legal-move');
        });
    }
}

async function handleSquareClick(square, piece) {
    if (!isMyTurn()) return;
    
    if (selectedSquare === null) {
        const myPieces = myColor === 'white' ? 'PNBRQK' : 'pnbrqk';
        if (piece && myPieces.includes(piece)) {
            selectedSquare = square;
            await fetchLegalMoves(square);
            updateVisualState();
        }
    } else {
        if (legalMoves.includes(square)) {
            makeMove(selectedSquare + square);
        } else {
            const myPieces = myColor === 'white' ? 'PNBRQK' : 'pnbrqk';
            if (piece && myPieces.includes(piece)) {
                selectedSquare = square;
                await fetchLegalMoves(square);
                updateVisualState();
            } else {
                selectedSquare = null;
                legalMoves = [];
                updateVisualState();
            }
        }
    }
}

async function fetchLegalMoves(square) {
    try {
        const response = await fetch('/api/get-legal-moves', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ board: board, square: square })
        });
        const data = await response.json();
        legalMoves = data.legal_moves || [];
    } catch (error) {
        legalMoves = [];
    }
}

function makeMove(move) {
    socket.emit('move', {
        room: roomCode,
        move: move,
        board: board
    });
    
    selectedSquare = null;
    legalMoves = [];
}

function handleGameOver(result) {
    let message = '';
    if (result === '1-0') {
        message = 'üéâ Les Blancs ont gagn√© !';
    } else if (result === '0-1') {
        message = 'üéâ Les Noirs ont gagn√© !';
    } else {
        message = 'ü§ù Match nul !';
    }
    
    document.getElementById('gameStatus').innerHTML = message;
    setTimeout(() => alert(message), 500);
}

function copyCode() {
    const fullUrl = window.location.href;
    navigator.clipboard.writeText(fullUrl);
    alert('‚úÖ Lien copi√© : ' + fullUrl + '\n\nEnvoyez ce lien √† votre ami !');
}

function leaveRoom() {
    if (confirm('Quitter le salon ?')) {
        socket.emit('leave', { room: roomCode });
        window.location.href = '/';
    }
}

window.onbeforeunload = function() {
    socket.emit('leave', { room: roomCode });
};
</script>
{% endblock %}
