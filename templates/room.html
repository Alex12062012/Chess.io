{% extends "base.html" %}

{% block title %}Salon {{ code }} - chess.io{% endblock %}

{% block extra_css %}
<style>
    .room-container {
        max-width: 1000px;
        margin: 2rem auto;
    }

    .room-header {
        background: #262421;
        border: 2px solid #3d3b38;
        border-radius: 16px;
        padding: 2rem;
        margin-bottom: 2rem;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        text-align: center;
    }

    .room-header h2 {
        color: #b8b6b3;
        margin-bottom: 1rem;
    }

    .room-code {
        font-size: 3rem;
        font-weight: bold;
        color: #81b64c;
        letter-spacing: 0.5rem;
        margin: 1rem 0;
        font-family: monospace;
    }

    .share-info {
        background: rgba(129, 182, 76, 0.1);
        padding: 1rem;
        border-radius: 8px;
        margin-top: 1rem;
        color: #81b64c;
        border: 1px solid #81b64c;
    }

    .copy-btn {
        background: #81b64c;
        color: white;
        border: none;
        padding: 0.6rem 1.5rem;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        margin-top: 0.5rem;
        transition: all 0.3s;
    }

    .copy-btn:hover {
        background: #9ac95a;
        transform: translateY(-2px);
    }

    .game-layout {
        display: grid;
        grid-template-columns: 1fr 500px 1fr;
        gap: 2rem;
        align-items: start;
    }

    .player-info {
        background: #262421;
        border: 2px solid #3d3b38;
        border-radius: 16px;
        padding: 1.5rem;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        text-align: center;
    }

    .player-name {
        font-size: 1.5rem;
        font-weight: bold;
        margin-bottom: 0.5rem;
        color: #b8b6b3;
    }

    .player-color {
        display: inline-block;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-weight: 600;
        margin-top: 0.5rem;
    }

    .player-white {
        background: #3d3b38;
        color: #eeeed2;
    }

    .player-black {
        background: #1a1917;
        color: #b8b6b3;
        border: 2px solid #3d3b38;
    }

    .waiting-player {
        color: #7c7a77;
        font-style: italic;
        padding: 2rem;
    }

    .chess-board-wrapper {
        background: #262421;
        border: 2px solid #3d3b38;
        border-radius: 16px;
        padding: 2rem;
        box-shadow: 0 8px 24px rgba(0,0,0,0.4);
    }

    .chess-board {
        display: grid;
        grid-template-columns: repeat(8, 60px);
        grid-template-rows: repeat(8, 60px);
        border: 4px solid #3d3b38;
        margin: 0 auto;
        width: fit-content;
        box-shadow: 0 4px 16px rgba(0,0,0,0.4);
    }

    .square {
        width: 60px;
        height: 60px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s;
        user-select: none;
        position: relative;
    }

    .piece-img {
        width: 52px;
        height: 52px;
        filter: drop-shadow(0 1px 2px rgba(0,0,0,0.3));
        position: absolute;
        pointer-events: none !important;
        -webkit-user-drag: none;
    }

    .square.light { background-color: #eeeed2; }
    .square.dark { background-color: #769656; }

    .square.selected {
        background-color: #baca44 !important;
        box-shadow: inset 0 0 10px rgba(0,0,0,0.3);
    }

    .square.legal-move::after {
        content: '';
        position: absolute;
        width: 20px;
        height: 20px;
        background: rgba(0, 0, 0, 0.15);
        border-radius: 50%;
    }

    .square:hover {
        opacity: 0.9;
    }

    .game-status {
        background: #1a1917;
        padding: 1rem;
        border-radius: 10px;
        text-align: center;
        margin-bottom: 1rem;
        font-weight: 600;
        border: 2px solid #3d3b38;
        color: #b8b6b3;
    }

    .control-btn {
        padding: 0.8rem;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        width: 100%;
        margin-top: 1rem;
        background: #cc3f3f;
        color: white;
        font-family: 'Inter', sans-serif;
    }

    .control-btn:hover {
        background: #b33636;
    }

    @media (max-width: 1200px) {
        .game-layout {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="room-container">
    <div class="room-header">
        <h2>üîí Salon Priv√©</h2>
        <div class="room-code">{{ code }}</div>
        
        {% if room.status == 'waiting' %}
        <div class="share-info">
            üì§ Partagez ce code avec votre ami pour qu'il rejoigne la partie
        </div>
        <button class="copy-btn" onclick="copyCode()">
            üìã Copier le code
        </button>
        {% else %}
        <div class="share-info" style="background: rgba(129, 182, 76, 0.2); color: #9ac95a; border-color: #9ac95a;">
            ‚úÖ Les deux joueurs sont pr√©sents - La partie peut commencer !
        </div>
        {% endif %}
    </div>

    <div class="game-layout">
        <div class="player-info">
            <div class="player-name">
                {% if room.player_white %}
                    {{ room.player_white }}
                {% else %}
                    En attente...
                {% endif %}
            </div>
            <div class="player-color player-white">‚ôî Blancs</div>
        </div>

        <div class="chess-board-wrapper">
            <div class="game-status" id="gameStatus">
                {% if room.status == 'waiting' %}
                    ‚è≥ En attente du joueur noir...
                {% else %}
                    ‚ñ∂Ô∏è Au tour des Blancs
                {% endif %}
            </div>

            <div class="chess-board" id="chessBoard"></div>

            <button class="control-btn" onclick="leaveRoom()">
                üö™ Quitter le salon
            </button>
        </div>

        <div class="player-info">
            <div class="player-name">
                {% if room.player_black %}
                    {{ room.player_black }}
                {% else %}
                    <span class="waiting-player">En attente...</span>
                {% endif %}
            </div>
            <div class="player-color player-black">‚ôö Noirs</div>
        </div>
    </div>
</div>

<script>
const PIECE_IMAGES = {
    'P': 'https://images.chesscomfiles.com/chess-themes/pieces/neo/150/wp.png',
    'N': 'https://images.chesscomfiles.com/chess-themes/pieces/neo/150/wn.png',
    'B': 'https://images.chesscomfiles.com/chess-themes/pieces/neo/150/wb.png',
    'R': 'https://images.chesscomfiles.com/chess-themes/pieces/neo/150/wr.png',
    'Q': 'https://images.chesscomfiles.com/chess-themes/pieces/neo/150/wq.png',
    'K': 'https://images.chesscomfiles.com/chess-themes/pieces/neo/150/wk.png',
    'p': 'https://images.chesscomfiles.com/chess-themes/pieces/neo/150/bp.png',
    'n': 'https://images.chesscomfiles.com/chess-themes/pieces/neo/150/bn.png',
    'b': 'https://images.chesscomfiles.com/chess-themes/pieces/neo/150/bb.png',
    'r': 'https://images.chesscomfiles.com/chess-themes/pieces/neo/150/br.png',
    'q': 'https://images.chesscomfiles.com/chess-themes/pieces/neo/150/bq.png',
    'k': 'https://images.chesscomfiles.com/chess-themes/pieces/neo/150/bk.png'
};

const socket = io();
const roomCode = '{{ code }}';

let board = '{{ room.board_state }}';
let selectedSquare = null;
let legalMoves = [];
let myColor = null;
let currentTurn = '{{ room.current_turn }}';

window.onload = function() {
    const playerWhite = '{{ room.player_white }}';
    const playerBlack = '{{ room.player_black }}';
    const myUsername = '{{ session.username if session.username else "Invit√©" }}';
    
    if (myUsername === playerWhite) {
        myColor = 'white';
    } else if (myUsername === playerBlack) {
        myColor = 'black';
    }
    
    socket.emit('join', { room: roomCode });
    renderBoard();
};

socket.on('player_joined', function(data) {
    console.log(data.username + ' a rejoint');
});

socket.on('move_made', function(data) {
    board = data.board;
    currentTurn = board.split(' ')[1] === 'w' ? 'white' : 'black';
    selectedSquare = null;
    legalMoves = [];
    renderBoard();
    
    if (data.game_over) {
        handleGameOver(data.result);
    }
});

function parseFEN(fen) {
    const ranks = fen.split(' ')[0].split('/');
    const pieces = [];
    
    for (let rank = 0; rank < 8; rank++) {
        let file = 0;
        for (let char of ranks[rank]) {
            if (char >= '1' && char <= '8') {
                for (let i = 0; i < parseInt(char); i++) {
                    pieces.push(null);
                    file++;
                }
            } else {
                pieces.push(char);
                file++;
            }
        }
    }
    return pieces;
}

function indexToSquare(index) {
    const file = index % 8;
    const rank = 7 - Math.floor(index / 8);
    return String.fromCharCode(97 + file) + (rank + 1);
}

function renderBoard() {
    const boardEl = document.getElementById('chessBoard');
    boardEl.innerHTML = '';
    
    const pieces = parseFEN(board);
    
    for (let i = 0; i < 64; i++) {
        const square = document.createElement('div');
        const rank = Math.floor(i / 8);
        const file = i % 8;
        
        square.className = 'square ' + ((rank + file) % 2 === 0 ? 'light' : 'dark');
        const squareName = indexToSquare(i);
        square.dataset.square = squareName;
        square.dataset.piece = pieces[i] || '';
        
        if (pieces[i]) {
            const img = document.createElement('img');
            img.src = PIECE_IMAGES[pieces[i]];
            img.className = 'piece-img';
            img.draggable = false;
            square.appendChild(img);
        }
        
        if (isMyTurn()) {
            square.onclick = function() {
                handleSquareClick(squareName, pieces[i] || '');
            };
        }
        
        boardEl.appendChild(square);
    }
    
    updateVisualState();
}

function isMyTurn() {
    if (!myColor) return false;
    return currentTurn === myColor;
}

function updateVisualState() {
    document.querySelectorAll('.square').forEach(sq => {
        sq.classList.remove('selected', 'legal-move');
    });
    
    if (selectedSquare !== null) {
        const selectedEl = document.querySelector(`[data-square="${selectedSquare}"]`);
        if (selectedEl) selectedEl.classList.add('selected');
        
        legalMoves.forEach(move => {
            const moveEl = document.querySelector(`[data-square="${move}"]`);
            if (moveEl) moveEl.classList.add('legal-move');
        });
    }
}

async function handleSquareClick(square, piece) {
    if (!isMyTurn()) return;
    
    if (selectedSquare === null) {
        const myPieces = myColor === 'white' ? 'PNBRQK' : 'pnbrqk';
        if (piece && myPieces.includes(piece)) {
            selectedSquare = square;
            await fetchLegalMoves(square);
            updateVisualState();
        }
    } else {
        if (legalMoves.includes(square)) {
            makeMove(selectedSquare + square);
        } else {
            const myPieces = myColor === 'white' ? 'PNBRQK' : 'pnbrqk';
            if (piece && myPieces.includes(piece)) {
                selectedSquare = square;
                await fetchLegalMoves(square);
                updateVisualState();
            } else {
                selectedSquare = null;
                legalMoves = [];
                updateVisualState();
            }
        }
    }
}

async function fetchLegalMoves(square) {
    try {
        const response = await fetch('/api/get-legal-moves', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ board: board, square: square })
        });
        const data = await response.json();
        legalMoves = data.legal_moves || [];
    } catch (error) {
        legalMoves = [];
    }
}

function makeMove(move) {
    socket.emit('move', {
        room: roomCode,
        move: move,
        board: board
    });
    
    selectedSquare = null;
    legalMoves = [];
}

function handleGameOver(result) {
    let message = '';
    if (result === '1-0') {
        message = 'üéâ Les Blancs ont gagn√© !';
    } else if (result === '0-1') {
        message = 'üéâ Les Noirs ont gagn√© !';
    } else {
        message = 'ü§ù Match nul !';
    }
    
    document.getElementById('gameStatus').innerHTML = message;
    setTimeout(() => alert(message), 500);
}

function copyCode() {
    navigator.clipboard.writeText(roomCode);
    alert('‚úÖ Code copi√© : ' + roomCode);
}

function leaveRoom() {
    if (confirm('Quitter le salon ?')) {
        socket.emit('leave', { room: roomCode });
        window.location.href = '/';
    }
}

window.onbeforeunload = function() {
    socket.emit('leave', { room: roomCode });
};
</script>
{% endblock %}
